// ==================== داده‌های LMS (ادغام شده) ====================
// داده‌های LMS برای دختران (61-228 ماهه) و پسران (61-228 ماهه)

(function() {
  // داده‌های خام دختران
  const girlsRaw = `Month	L	M	S
61	-1/848993606	15/43678861	0/120452799
62	-1/869726071	15/49113279	0/120818423
63	-1/889397159	15/54630293	0/121174423
64	-1/908029814	15/60226756	0/121521084
65	-1/925645589	15/65900003	0/121858677
66	-1/942265648	15/71647648	0/122187464
67	-1/957910765	15/77467568	0/122507699
68	-1/972601437	15/83357897	0/122819625
69	-1/986358	15/89317023	0/123123477
70	-1/999200303	15/95343483	0/12341948
71	-2/011147164	16/01435958	0/123707852
72	-2/022218287	16/07593272	0/123988802
73	-2/032432365	16/13814389	0/124262524
74	-2/041808101	16/20098392	0/124529202
75	-2/050364229	16/26444462	0/124789013
76	-2/058119506	16/32851873	0/125042128
77	-2/065092723	16/39319986	0/125288711
78	-2/071302705	16/45848243	0/125528921
79	-2/076768316	16/52436162	0/125762911
80	-2/081508463	16/59083331	0/125990828
81	-2/085542101	16/65789414	0/126212813
82	-2/088888245	16/72554143	0/12642900
83	-2/091565966	16/79377316	0/126639518
84	-2/093594393	16/86258795	0/126844496
85	-2/094992715	16/93198512	0/127044048
86	-2/095780187	17/00196464	0/127238282
87	-2/095976136	17/07252706	0/127427303
88	-2/095599969	17/14367349	0/127611207
89	-2/094671172	17/21540552	0/127790087
90	-2/093209318	17/28772522	0/127964031
91	-2/091234071	17/36063514	0/128133122
92	-2/088765184	17/43413827	0/128297438
93	-2/085822502	17/50823803	0/128457052
94	-2/082425971	17/58293834	0/128612034
95	-2/078595639	17/65824356	0/128762451
96	-2/07435165	17/73415849	0/128908366
97	-2/069714256	17/81068835	0/129049839
98	-2/064703813	17/88783879	0/129186928
99	-2/059340783	17/96561588	0/12931969
100	-2/053646741	18/04402611	0/129448177
101	-2/047643377	18/12307642	0/129572443
102	-2/041352492	18/20277417	0/129692534
103	-2/034796012	18/28312716	0/129808495
104	-2/027995982	18/36414363	0/129920367
105	-2/020974565	18/44583226	0/130028189
106	-2/013754042	18/52820215	0/130131998
107	-2/00635682	18/61126281	0/130231829
108	-1/998805428	18/69502417	0/130327715
109	-1/991122519	18/77949656	0/130419687
110	-1/983330877	18/86469076	0/130507777
111	-1/975453414	18/95061789	0/130592014
112	-1/967513168	19/03728952	0/130672424
113	-1/959533308	19/12471757	0/130749035
114	-1/951537135	19/2129144	0/130821872
115	-1/943548088	19/30189272	0/130890961
116	-1/935589741	19/39166559	0/130956326
117	-1/927685795	19/48224639	0/131017991
118	-1/919860086	19/57364884	0/131075979
119	-1/912136592	19/66588698	0/13113031
120	-1/904539437	19/75897523	0/131181006
121	-1/897092883	19/85292834	0/131228088
122	-1/889821334	19/94776142	0/131271574
123	-1/882749342	20/04348984	0/131311484
124	-1/875901609	20/14012925	0/131347837
125	-1/869302988	20/23769556	0/131380651
126	-1/862978488	20/33620494	0/131409944
127	-1/856953277	20/43567379	0/131435732
128	-1/851252664	20/53611873	0/131458033
129	-1/845901998	20/63755658	0/131476862
130	-1/840926666	20/74000438	0/131492236
131	-1/836352076	20/84347938	0/131504169
132	-1/832203661	20/94799904	0/131512677
133	-1/828507	21/05358102	0/131517775
134	-1/825287714	21/16024312	0/131519478
135	-1/822571466	21/26800328	0/1315178
136	-1/820383954	21/37687956	0/131512756
137	-1/818750908	21/48689012	0/131504362
138	-1/817698087	21/59805323	0/131492641
139	-1/817251278	21/71038726	0/131477606
140	-1/817436301	21/82391066	0/131459272
141	-1/818279004	21/93864197	0/131437656
142	-1/819805261	22/05459978	0/131412773
143	-1/822040965	22/17180275	0/13138464
144	-1/825012025	22/29026956	0/131353274
145	-1/828744366	22/41001896	0/131318693
146	-1/833263925	22/53106971	0/131280916
147	-1/838596645	22/65344062	0/131239962
148	-1/844768474	22/77715053	0/131195852
149	-1/851805363	22/90221832	0/131148606
150	-1/859733263	23/02866291	0/131098245
151	-1/868578124	23/15650327	0/13104479
152	-1/878366896	23/28575837	0/130988264
153	-1/889126528	23/41644721	0/130928691
154	-1/900883969	23/54858883	0/130866095
155	-1/913666166	23/68220228	0/1308005
156	-1/927500067	23/81730662	0/130731933
157	-1/942412618	23/95392095	0/130660419
158	-1/958430765	24/09206438	0/130585984
159	-1/975581454	24/23175607	0/130508655
160	-1/993891629	24/37301517	0/130428462
161	-2/013388235	24/51586085	0/130345434
162	-2/034098215	24/6603123	0/130259603
163	-2/056048511	24/80638874	0/130170998
164	-2/079266065	24/95410937	0/13007965
165	-2/103777819	25/10349342	0/129985592
166	-2/129610711	25/25456012	0/129888857
167	-2/15679168	25/40732871	0/12978948
168	-2/185346661	25/56181843	0/129687496
169	-2/215301587	25/71804852	0/129582942
170	-2/246683391	25/87603824	0/129475858
171	-2/279518003	26/03580684	0/129366283
172	-2/313831354	26/19737358	0/129254258
173	-2/349649376	26/36075771	0/129139822
174	-2/387	26/52597848	0/129023017
175	-2/425909113	26/69305516	0/128903886
176	-2/466402616	26/86200701	0/128782474
177	-2/508506336	27/03285328	0/128658826
178	-2/552246097	27/20561324	0/128532989
179	-2/597647716	27/38030615	0/128405012
180	-2/644737008	27/55695126	0/128274944
181	-2/693539788	27/73556784	0/128142836
182	-2/744081868	27/91617515	0/128008741
183	-2/796388055	28/09879244	0/127872712
184	-2/850483154	28/28343898	0/127734803
185	-2/906391968	28/47013404	0/127595071
186	-2/964139299	28/65889689	0/127453575
187	-3/02374995	28/84974679	0/127310374
188	-3/085247724	29/04270302	0/127165531
189	-3/14865842	29/23778487	0/127019108
190	-3/213955836	29/43501163	0/126871172
191	-3/281163769	29/63440259	0/126721789
192	-3/350306019	29/83597704	0/126571027
193	-3/421406384	30/03975427	0/126418956
194	-3/494488666	30/24575357	0/126265649
195	-3/569576666	30/4539943	0/126111178
196	-3/646694185	30/66449579	0/125955617
197	-3/725865024	30/87727737	0/125799043
198	-3/807112984	31/09235838	0/125641533
199	-3/890461867	31/3097582	0/125483165
200	-3/975935472	31/52949622	0/125324021
201	-4/063557599	31/75159183	0/125164184
202	-4/153352049	31/97606442	0/125003739
203	-4/245342619	32/20293339	0/124842775
204	-4/339553108	32/43221813	0/124681382
205	-4/436007315	32/66393804	0/12451965
206	-4/534728039	32/89811254	0/124357675
207	-4/635738077	33/13476104	0/124195549
208	-4/73906023	33/37390296	0/124033371
209	-4/844717301	33/6155577	0/123871239
210	-4/952731092	33/85974467	0/123709254
211	-5/063124408	34/10648326	0/123547518
212	-5/17592005	34/35579288	0/123386137
213	-5/291140823	34/60769292	0/123225218
214	-5/408809534	34/86220277	0/123064869
215	-5/528948989	35/11934181	0/122905201
216	-5/651581994	35/37912942	0/122746326
217	-5/776731355	35/64158496	0/122588361
218	-5/904419878	35/90672781	0/122431424
219	-6/034670371	36/17457732	0/122275636
220	-6/16750564	36/44515284	0/122121121
221	-6/302948492	36/71847373	0/121968005
222	-6/441021732	36/99455932	0/121816419
223	-6/581748165	37/27342897	0/121666497
224	-6/725150595	37/555102	0/121518376
225	-6/871251828	37/83959776	0/121372197
226	-7/020074668	38/12693556	0/121228104
227	-7/171641921	38/41713474	0/121086246
228	-7/325976393	38/71021462	0/120946775`;

  // داده‌های خام پسران
  const boysRaw = `Month	L	M	S
61	-1/734228205	15/28659136	0/120640222
62	-1/756792218	15/33887307	0/120999148
63	-1/778255579	15/39188263	0/121348492
64	-1/798636823	15/44561022	0/121688532
65	-1/81795375	15/50004898	0/122019536
66	-1/836223414	15/55519392	0/122341762
67	-1/853462109	15/61104193	0/122655457
68	-1/869685364	15/66759175	0/122960857
69	-1/884908942	15/72484395	0/123258192
70	-1/899148843	15/78280089	0/123547682
71	-1/912421294	15/84146678	0/123829537
72	-1/924742754	15/90084761	0/124103959
73	-1/936129907	15/96095112	0/124371141
74	-1/946599658	16/02178679	0/124631266
75	-1/956169134	16/08336581	0/124884509
76	-1/964855682	16/1457	0/125131035
77	-1/972676864	16/20880191	0/125371001
78	-1/979650456	16/2726852	0/125604557
79	-1/985794437	16/33736371	0/125831844
80	-1/991126982	16/40285222	0/126052998
81	-1/995666462	16/46916643	0/126268147
82	-1/999431436	16/53632288	0/126477415
83	-2/002440652	16/60433893	0/126680921
84	-2/004713046	16/67323277	0/126878777
85	-2/006267743	16/74302345	0/127071089
86	-2/007124055	16/81373085	0/127257959
87	-2/007301479	16/88537572	0/127439484
88	-2/006819697	16/95797963	0/127615755
89	-2/005698577	17/03156504	0/127786862
90	-2/003958164	17/10615532	0/127952888
91	-2/001618683	17/18177474	0/128113913
92	-1/998700541	17/25844843	0/128270011
93	-1/995224317	17/33620241	0/128421255
94	-1/991210765	17/41506357	0/128567712
95	-1/986680802	17/49505968	0/128709444
96	-1/981655508	17/57621937	0/128846513
97	-1/976156123	17/65857216	0/128978976
98	-1/970204044	17/74214844	0/129106888
99	-1/963820817	17/82697949	0/129230302
100	-1/957028138	17/91309742	0/129349271
101	-1/949847839	17/99053522	0/129463843
102	-1/942301889	18/08932678	0/129574065
103	-1/934412389	18/17950688	0/129679983
104	-1/926201558	18/27111124	0/129781641
105	-1/917691729	18/3641764	0/129879082
106	-1/908905351	18/45873978	0/129972345
107	-1/899864983	18/55483968	0/130061469
108	-1/890593293	18/65251525	0/130146491
109	-1/881113051	18/75180654	0/130227448
110	-1/871447124	18/85275448	0/130304375
111	-1/861618465	18/95540086	0/130377306
112	-1/851650109	19/05978833	0/130446275
113	-1/841565174	19/16596044	0/130511313
114	-1/831386856	19/2739615	0/130572452
115	-1/821138436	19/3838366	0/130629722
116	-1/81084318	19/49562162	0/130683153
117	-1/800524438	19/60936325	0/130732774
118	-1/790205536	19/72510902	0/130778613
119	-1/779909888	19/84290736	0/130820696
120	-1/769660887	19/96280756	0/130859053
121	-1/759481911	20/08485978	0/130893711
122	-1/749396324	20/20911511	0/130924696
123	-1/739427476	20/33562557	0/130952034
124	-1/729598701	20/46444407	0/130975752
125	-1/719933324	20/59562449	0/130995875
126	-1/71045466	20/72922161	0/131012428
127	-1/701186014	20/86529118	0/131025438
128	-1/692150685	20/99999995	0/131034928
129	-1/683371964	21/14525878	0/131040926
130	-1/674873134	21/28922942	0/131043456
131	-1/666677469	21/43597459	0/131042545
132	-1/658808237	21/58555804	0/131038218
133	-1/651288697	21/73804453	0/131030503
134	-1/644142103	21/89349983	0/131019425
135	-1/637391701	22/05199076	0/131005012
136	-1/631060734	22/21358523	0/130987291
137	-1/625172441	22/37835223	0/130966291
138	-1/619749056	22/54635182	0/130942041
139	-1/614812806	22/71765519	0/130914572
140	-1/610385919	22/89233463	0/130883913
141	-1/606490622	23/0704636	0/130850096
142	-1/603149139	23/25211674	0/130813152
143	-1/600383694	23/43737085	0/130773113
144	-1/598216509	23/62630395	0/130730014
145	-1/596669802	23/81899525	0/130683888
146	-1/595765792	24/01552515	0/130634772
147	-1/595526697	24/21597528	0/130582702
148	-1/595974735	24/42043851	0/130527717
149	-1/597132124	24/62899995	0/130469858
150	-1/599021082	24/84174604	0/130409166
151	-1/601663826	25/05876451	0/130345683
152	-1/60508257	25/28014438	0/130279454
153	-1/609299527	25/50597603	0/130210524
154	-1/614337909	25/73635118	0/130138941
155	-1/620219928	26/97136292	0/130064754
156	-1/626967794	26/21110571	0/129988013
157	-1/634603715	26/4556753	0/129908769
158	-1/643149897	26/70516874	0/129827075
159	-1/652628545	26/95968544	0/129742984
160	-1/663061862	27/21932615	0/129656552
161	-1/674472044	27/48418396	0/129567836
162	-1/686881288	27/75435437	0/129476896
163	-1/700311787	28/02993522	0/129383792
164	-1/714785732	28/31102677	0/129288585
165	-1/730325315	28/59773167	0/129191339
166	-1/746952727	28/89015501	0/129092119
167	-1/764690158	29/18840432	0/128990992
168	-1/783559799	29/49258956	0/128888026
169	-1/803583837	29/80282319	0/128783292
170	-1/824784458	30/11922019	0/128676861
171	-1/847183846	30/44189809	0/128568807
172	-1/870804182	30/77097698	0/128459203
173	-1/895667646	31/10657952	0/128348126
174	-1/921796414	31/44883096	0/12823565
175	-1/949212663	31/79785914	0/128121854
176	-1/977938567	32/15379458	0/128006818
177	-2/008996301	32/51677051	0/127890621
178	-2/041408037	32/88692284	0/127773347
179	-2/075195944	33/26438924	0/127655079
180	-2/110382191	33/64930919	0/127535904
181	-2/146988944	34/04182401	0/127415909
182	-2/185038366	34/44207688	0/127295182
183	-2/224552621	34/85021298	0/127173814
184	-2/265553872	35/26637944	0/127051897
185	-2/30806428	35/69072543	0/126929525
186	-2/352106008	36/12340219	0/126806794
187	-2/397702217	36/56456303	0/126683802
188	-2/444875069	37/01436342	0/126560649
189	-2/493646727	37/47296095	0/126437438
190	-2/544039351	37/94051536	0/126314272
191	-2/596075102	38/41718853	0/126191258
192	-2/649776139	38/90314449	0/126068503
193	-2/705164622	39/39855041	0/125946118
194	-2/76226271	39/90357561	0/125824214
195	-2/821092563	40/41839257	0/125702908
196	-2/881676339	40/94317696	0/125582316
197	-2/944036196	41/47810768	0/125462561
198	-3/008194287	42/02336691	0/125343766
199	-3/074172765	42/57913998	0/125226056
200	-3/141993781	43/14561547	0/125109558
201	-3/211679483	43/72298528	0/124994403
202	-3/283252019	44/31144467	0/124880724
203	-3/356733532	44/91119229	0/124768659
204	-3/432146163	45/52242927	0/124658348
205	-3/509512051	46/1453602	0/124549933
206	-3/588853333	46/78019309	0/124443561
207	-3/670192144	47/42713944	0/124339381
208	-3/753550619	48/08641424	0/124237547
209	-3/838950893	48/75824595	0/124138217
210	-3/926415101	49/44286649	0/124041552
211	-4/015965375	50/14050125	0/123947718
212	-4/10762384	50/85138911	0/123856887
213	-4/201413623	51/57577248	0/123769233
214	-4/297356851	52/31389728	0/123684935
215	-4/39547565	53/06601288	0/123604178
216	-4/495802146	53/83237212	0/123527151
217	-4/598358465	54/61323137	0/123454048
218	-4/703166732	55/40885058	0/123385069
219	-4/810249074	56/21949327	0/123320421
220	-4/919627618	57/04542662	0/123260318
221	-5/031324488	57/88692146	0/12320498
222	-5/145361809	58/74425224	0/123154636
223	-5/261761708	59/61769706	0/123109521
224	-5/380546312	60/50753773	0/123069877
225	-5/501737749	61/41406067	0/12303595
226	-5/625358148	62/33755601	0/123007995
227	-5/751429638	63/27832769	0/122986275
228	-5/87997435	64/23667345	0/122971063`;

  // تابع پردازش داده‌های LMS
  function parseLMS(rawData) {
    const lines = rawData.trim().split('\n');
    const data = new Map();
    
    // شروع از خط دوم (رد کردن header)
    for (let i = 1; i < lines.length; i++) {
      const parts = lines[i].split('\t');
      if (parts.length >= 4) {
        const month = parseInt(parts[0]);
        // تبدیل / به . برای اعداد اعشاری
        const L = parseFloat(parts[1].replace('/', '.'));
        const M = parseFloat(parts[2].replace('/', '.'));
        const S = parseFloat(parts[3].replace('/', '.'));
        
        data.set(month, { L, M, S });
      }
    }
    
    return data;
  }

  // ایجاد داده‌های سراسری
  window.LMS = {
    girls: parseLMS(girlsRaw),
    boys: parseLMS(boysRaw)
  };
})();

// نگاشت داده‌های LMS به متغیرهای مورد استفاده در کد
const LMS_FEMALE = window.LMS.girls;
const LMS_MALE = window.LMS.boys;

// ==================== منطق اصلی برنامه ====================

// تنظیمات اولیه و متغیرهای سراسری
let selectedGender = null;

// پر کردن لیست سال‌ها (از 1320 تا امسال)
function populateYearDropdown() {
  const yearSelect = document.getElementById('birthYear');
  const currentYear = 1404; // سال جاری شمسی
  
  for (let year = currentYear; year >= 1320; year--) {
    const option = document.createElement('option');
    option.value = year;
    option.textContent = year;
    yearSelect.appendChild(option);
  }
}

// پر کردن لیست روزها بر اساس ماه انتخابی
function populateDayDropdown() {
  const monthSelect = document.getElementById('birthMonth');
  const yearSelect = document.getElementById('birthYear');
  const daySelect = document.getElementById('birthDay');
  
  const selectedMonth = parseInt(monthSelect.value);
  const selectedYear = parseInt(yearSelect.value);
  
  // پاک کردن گزینه‌های قبلی
  daySelect.innerHTML = '<option value="">روز</option>';
  
  if (!selectedMonth) return;
  
  let daysInMonth;
  if (selectedMonth <= 6) {
    daysInMonth = 31;
  } else if (selectedMonth <= 11) {
    daysInMonth = 30;
  } else {
    // اسفند: بررسی کبیسه بودن
    daysInMonth = (selectedYear && isLeapPersianYear(selectedYear)) ? 30 : 29;
  }
  
  for (let day = 1; day <= daysInMonth; day++) {
    const option = document.createElement('option');
    option.value = day;
    option.textContent = day;
    daySelect.appendChild(option);
  }
}

// رویدادهای تغییر ماه و سال برای به‌روزرسانی روزها
document.getElementById('birthMonth').addEventListener('change', populateDayDropdown);
document.getElementById('birthYear').addEventListener('change', populateDayDropdown);

// فراخوانی تابع پر کردن سال‌ها هنگام بارگذاری صفحه
document.addEventListener('DOMContentLoaded', () => {
  populateYearDropdown();
});

// رویداد انتخاب جنسیت
document.querySelectorAll('.gender-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.gender-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    selectedGender = btn.dataset.gender;
  });
});

// رویداد محاسبه
document.getElementById('calculateBtn').addEventListener('click', calculate);

// رویداد دانلود PDF
document.getElementById('downloadPdfBtn').addEventListener('click', downloadPDF);

// تابع اصلی محاسبه
function calculate() {
  // دریافت مقادیر ورودی
  const yearInput = document.getElementById('birthYear').value;
  const monthInput = document.getElementById('birthMonth').value;
  const dayInput = document.getElementById('birthDay').value;
  const height = parseFloat(document.getElementById('height').value);
  const weight = parseFloat(document.getElementById('weight').value);
  const activityLevel = document.getElementById('activityLevel').value;

  // اعتبارسنجی ورودی‌ها
  if (!selectedGender) {
    showToast('لطفاً جنسیت را انتخاب کنید');
    return;
  }
  if (!yearInput || !monthInput || !dayInput) {
    showToast('لطفاً تاریخ تولد را کامل وارد کنید');
    return;
  }
  if (!height || height <= 0) {
    showToast('لطفاً قد را به درستی وارد کنید');
    return;
  }
  if (!weight || weight <= 0) {
    showToast('لطفاً وزن را به درستی وارد کنید');
    return;
  }

  // تبدیل تاریخ شمسی به میلادی
  const birthYear = parseInt(yearInput);
  const birthMonth = parseInt(monthInput);
  const birthDay = parseInt(dayInput);
  
  const gregorianBirth = persianToGregorian(birthYear, birthMonth, birthDay);
  
  // محاسبه سن دقیق
  const today = new Date();
  const ageInfo = calculatePersianAge(birthYear, birthMonth, birthDay, today);
  
  // محاسبه BMI
  const heightInMeters = height / 100;
  const bmi = weight / (heightInMeters * heightInMeters);
  
  // تعیین وضعیت BMI
  let bmiStatus = '';
  let bmiColor = '';
  
  // اگر کودک یا نوجوان است (5 تا 19 سال)
  if (ageInfo.totalMonths >= 61 && ageInfo.totalMonths <= 228) {
    const zScore = calculateZScore(selectedGender, ageInfo.totalMonths, bmi);
    
    if (zScore !== null) {
      if (zScore < -2) {
        bmiStatus = 'لاغری شدید';
        bmiColor = '#ef4444';
      } else if (zScore < -1) {
        bmiStatus = 'لاغر';
        bmiColor = '#f97316';
      } else if (zScore <= 1) {
        bmiStatus = 'طبیعی';
        bmiColor = '#10b981';
      } else if (zScore <= 2) {
        bmiStatus = 'اضافه وزن';
        bmiColor = '#f59e0b';
      } else {
        bmiStatus = 'چاقی';
        bmiColor = '#ef4444';
      }
      
      // نمایش Z-Score
      document.getElementById('growthAssessment').innerHTML = `
        <div style="margin-top: 10px;">
          <strong>ارزیابی رشد (بر اساس WHO):</strong><br>
          Z-Score: ${zScore.toFixed(2)}<br>
          وضعیت: <span style="color: ${bmiColor}; font-weight: bold;">${bmiStatus}</span>
        </div>
      `;
    } else {
      bmiStatus = getAdultBMIStatus(bmi);
      bmiColor = getAdultBMIColor(bmi);
      document.getElementById('growthAssessment').innerHTML = '<div style="margin-top: 10px;">ارزیابی رشد: داده‌های LMS برای این سن در دسترس نیست</div>';
    }
  } else {
    // برای بزرگسالان
    bmiStatus = getAdultBMIStatus(bmi);
    bmiColor = getAdultBMIColor(bmi);
    document.getElementById('growthAssessment').innerHTML = '<div style="margin-top: 10px;">ارزیابی رشد: فقط برای سنین 5 تا 19 سال</div>';
  }
  
  // محاسبه BMR (فرمول Mifflin-St Jeor)
  let bmr;
  if (selectedGender === 'male') {
    bmr = (10 * weight) + (6.25 * height) - (5 * ageInfo.totalYears) + 5;
  } else {
    bmr = (10 * weight) + (6.25 * height) - (5 * ageInfo.totalYears) - 161;
  }
  
  // محاسبه TDEE بر اساس سطح فعالیت
  const activityMultipliers = {
    sedentary: 1.2,
    light: 1.375,
    moderate: 1.55,
    active: 1.725,
    veryActive: 1.9
  };
  
  const tdee = bmr * activityMultipliers[activityLevel];
  
  // نمایش نتایج
  document.getElementById('ageResult').textContent = 
    `${ageInfo.years} سال، ${ageInfo.months} ماه، ${ageInfo.days} روز`;
  
  document.getElementById('bmiResult').innerHTML = 
    `<strong style="font-size: 1.3em;">${bmi.toFixed(1)}</strong><br>
     <span style="color: ${bmiColor}; font-weight: bold;">${bmiStatus}</span>`;
  
  document.getElementById('bmrResult').textContent = `${Math.round(bmr)} کالری در روز`;
  document.getElementById('tdeeResult').textContent = `${Math.round(tdee)} کالری در روز`;
  
  // نمایش بخش نتایج
  document.getElementById('results').style.display = 'block';
  
  showToast('محاسبات با موفقیت انجام شد');
}

// تابع محاسبه Z-Score با استفاده از جداول LMS
function calculateZScore(gender, ageInMonths, bmi) {
  const lmsData = gender === 'male' ? LMS_MALE : LMS_FEMALE;
  
  if (!lmsData.has(ageInMonths)) {
    return null;
  }
  
  const { L, M, S } = lmsData.get(ageInMonths);
  
  // فرمول محاسبه Z-Score بر اساس روش LMS
  const zScore = (Math.pow(bmi / M, L) - 1) / (L * S);
  
  return zScore;
}

// تابع تعیین وضعیت BMI برای بزرگسالان
function getAdultBMIStatus(bmi) {
  if (bmi < 18.5) return 'کمبود وزن';
  if (bmi < 25) return 'وزن طبیعی';
  if (bmi < 30) return 'اضافه وزن';
  return 'چاقی';
}

// تابع تعیین رنگ وضعیت BMI برای بزرگسالان
function getAdultBMIColor(bmi) {
  if (bmi < 18.5) return '#f97316';
  if (bmi < 25) return '#10b981';
  if (bmi < 30) return '#f59e0b';
  return '#ef4444';
}

// تابع محاسبه سن دقیق شمسی
function calculatePersianAge(birthYear, birthMonth, birthDay, currentDate) {
  const currentPersian = gregorianToPersian(
    currentDate.getFullYear(),
    currentDate.getMonth() + 1,
    currentDate.getDate()
  );
  
  let years = currentPersian.year - birthYear;
  let months = currentPersian.month - birthMonth;
  let days = currentPersian.day - birthDay;
  
  if (days < 0) {
    months--;
    const daysInPrevMonth = getDaysInPersianMonth(
      months === 0 ? currentPersian.year - 1 : currentPersian.year,
      months === 0 ? 12 : currentPersian.month - 1
    );
    days += daysInPrevMonth;
  }
  
  if (months < 0) {
    years--;
    months += 12;
  }
  
  // محاسبه تعداد کل ماه‌ها برای استفاده در جداول LMS
  const totalMonths = years * 12 + months;
  
  return {
    years,
    months,
    days,
    totalMonths,
    totalYears: years + months / 12 + days / 365
  };
}

// تابع تعداد روزهای هر ماه شمسی
function getDaysInPersianMonth(year, month) {
  if (month <= 6) return 31;
  if (month <= 11) return 30;
  return isLeapPersianYear(year) ? 30 : 29;
}

// تابع تشخیص سال کبیسه شمسی
function isLeapPersianYear(year) {
  const breaks = [1, 5, 9, 13, 17, 22, 26, 30];
  const cycle = 33;
  const yearInCycle = ((year - 474) % cycle + cycle) % cycle;
  return breaks.includes(yearInCycle);
}

// تابع تبدیل تاریخ شمسی به میلادی
function persianToGregorian(jy, jm, jd) {
  let sal_a, gy, gm, gd, days;
  
  jy += 1595;
  days = 365 * jy + Math.floor(jy / 33) * 8 + Math.floor((jy % 33 + 3) / 4) + 78 + jd;
  
  if (jm < 7) {
    days += (jm - 1) * 31;
  } else {
    days += (jm - 7) * 30 + 186;
  }
  
  gy = 400 * Math.floor(days / 146097);
  days %= 146097;
  
  let flag = true;
  if (days >= 36525) {
    days--;
    gy += 100 * Math.floor(days / 36524);
    days %= 36524;
    if (days >= 365) days++;
    else flag = false;
  }
  
  gy += 4 * Math.floor(days / 1461);
  days %= 1461;
  
  if (flag) {
    if (days >= 366) {
      days--;
      gy += Math.floor(days / 365);
      days = days % 365;
    }
  }
  
  const monthDays = [31, 28 + (isLeapGregorian(gy + 1) ? 1 : 0), 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
  gm = 0;
  while (gm < 12 && days >= monthDays[gm]) {
    days -= monthDays[gm];
    gm++;
  }
  gd = days + 1;
  gm += 1;
  
  return { year: gy, month: gm, day: gd };
}

// تابع تبدیل تاریخ میلادی به شمسی
function gregorianToPersian(gy, gm, gd) {
  let days = 0;
  const monthDays = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
  
  for (let i = 0; i < gm - 1; i++) {
    days += monthDays[i];
  }
  
  if (gm > 2 && isLeapGregorian(gy)) days++;
  days += gd;
  
  const leapYears = Math.floor((gy - 1) / 4) - Math.floor((gy - 1) / 100) + Math.floor((gy - 1) / 400);
  days += (gy - 1) * 365 + leapYears;
  
  let jy = Math.floor((days - 79) / 365.25);
  const persianEpoch = persianNewYear(jy);
  
  if (days < persianEpoch) {
    jy--;
  }
  
  const dayOfYear = days - persianNewYear(jy) + 1;
  let jm, jd;
  
  if (dayOfYear <= 186) {
    jm = Math.ceil(dayOfYear / 31);
    jd = dayOfYear - (jm - 1) * 31;
  } else {
    jm = Math.ceil((dayOfYear - 186) / 30) + 6;
    jd = dayOfYear - 186 - (jm - 7) * 30;
  }
  
  return { year: jy, month: jm, day: jd };
}

// تابع محاسبه روز نوروز در تقویم میلادی
function persianNewYear(jy) {
  const breaks = [
    -61, 9, 38, 199, 426, 686, 756, 818, 1111, 1181, 1210,
    1635, 2060, 2097, 2192, 2262, 2324, 2394, 2456, 3178
  ];
  
  let jp = breaks[0];
  let jump = 0;
  
  for (let i = 1; i < breaks.length; i++) {
    const jm = breaks[i];
    jump = jm - jp;
    if (jy < jm) break;
    jp = jm;
  }
  
  let n = jy - jp;
  
  if (jump - n < 6) n = n - jump + (jump + 4) / 33 * 33;
  
  let leap = ((n + 1) % 33 - 1) % 4;
  if (leap === -1) leap = 4;
  
  const gy = jy + 621;
  const leapYears = Math.floor((gy - 1) / 4) - Math.floor((gy - 1) / 100) + Math.floor((gy - 1) / 400);
  
  return (gy - 1) * 365 + leapYears + 79 + n * 365 + Math.floor(n / 33) * 8 + Math.floor((n % 33 + 3) / 4);
}

// تابع تشخیص سال کبیسه میلادی
function isLeapGregorian(year) {
  return (year % 4 === 0 && year % 100 !== 0) || (year % 400 === 0);
}

// تابع نمایش پیام Toast
function showToast(message) {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.classList.add('show');
  
  setTimeout(() => {
    toast.classList.remove('show');
  }, 3000);
}

// تابع دانلود PDF
function downloadPDF() {
  const resultsDiv = document.getElementById('results');
  
  if (resultsDiv.style.display === 'none') {
    showToast('ابتدا محاسبات را انجام دهید');
    return;
  }
  
  const opt = {
    margin: 10,
    filename: 'bmi-report.pdf',
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: 2 },
    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
  };
  
  html2pdf().set(opt).from(resultsDiv).save();
}
